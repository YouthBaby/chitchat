<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>群聊</title>
</head>

<body>
    <div style="float: left; width: 30%">
        发给
        <input type="text" id="nameinput">
        <button id="adduser">添加用户</button>
        <input type="text" id="username">
        <hr> 私聊
        <input type="text" id="msginput">
        <button id="sendmsg">发送</button>
        <input type="file" id="picture">
        <button id="sendImg">发送图片</button>
    </div>
    <div style="float: left; width: 65%" id="chatbox">

    </div>
</body>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
<script>  
    let socket = io.connect('http://localhost:3000')

    let msgInput = $('#msginput'),
        nameInput = $('#nameinput'),
        username = $('#username')

    $('#adduser').click(() => {
        let name = username.val()
        socket.emit('adduser', { name })
    })

    $('#sendmsg').click(() => {
        let from = username.val()
        let to = nameInput.val()
        let msg = msgInput.val()
        socket.emit('compose', { from, to, msg })
    })

    socket.on('receiveMsg', (data) => {
        $('#chatbox').append($(`<div>${data.from}: ${data.msg}</div>`))
    })

    $('#sendImg').click(() => {
        let Imginput = document.getElementById('picture')
        let file = Imginput.files[0]       //得到该图片 
        let formData = new FormData()
        formData.append(file.name, file)
        $.ajax({
            type: "POST",
            url: '/sendimg',
            data: formData,
            contentType: false,
            processData: false,
            success: (res) => {
                let from = username.val()
                let to = nameInput.val()
                let data = { from, to, img: res }
                socket.emit('sendImg', data)
            }
        })
    })

    socket.on('receiveImg', (data) => {
        $('#chatbox').append($(`<div>${data.from}: <img src=/images/${data.img}></div>`))
    })  
</script>
</body>

</html>