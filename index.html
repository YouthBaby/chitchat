<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible"
          content="ie=edge">
    <title>群聊</title>
    <link rel="stylesheet"
          href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
          crossorigin="anonymous">
    <style>
        
    </style>
</head>

<body>
    <div class="container-fluid">
        <div id="chatbox"
             class=".col-xs-12 .col-md-12 .col-lg-12">
            <button type="button"
                    class="btn btn-primary btn-sm">发  送</button>
        </div>
        <div>
            发给
            <input type="text"
                   id="nameinput">
            <button id="adduser">添加用户</button>
            <input type="text"
                   id="username">
            <hr> 私聊
            <input type="text"
                   id="msginput">
            <button id="sendmsg">发送</button>
            <input type="file"
                   id="picture">
            <button id="sendImg">发送图片</button>
        </div>
    </div>
</body>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
<script src="/socket.io/socket.io.js"></script>
<script>  
    let socket = io.connect('http://localhost:3000')

    let msgInput = $('#msginput'),
        nameInput = $('#nameinput'),
        username = $('#username')

    $('#adduser').click(() => {
        let name = username.val()
        socket.emit('adduser', { name })
    })

    $('#sendmsg').click(() => {
        let from = username.val()
        let to = nameInput.val()
        let msg = msgInput.val()
        socket.emit('compose', { from, to, msg })
    })

    socket.on('receiveMsg', (data) => {
        $('#chatbox').append($(`<div>${data.from}: ${data.msg}</div>`))
    })

    $('#sendImg').click(() => {
        let Imginput = document.getElementById('picture')
        let file = Imginput.files[0]       //得到该图片 
        let formData = new FormData()
        formData.append(file.name, file)
        $.ajax({
            type: "POST",
            url: '/sendimg',
            data: formData,
            contentType: false,
            processData: false,
            success: (res) => {
                let from = username.val()
                let to = nameInput.val()
                let data = { from, to, img: res }
                socket.emit('sendImg', data)
            }
        })
    })

    socket.on('receiveImg', (data) => {
        $('#chatbox').append($(`<div>${data.from}: <img src=/images/${data.img}></div>`))
    })  
</script>
</body>

</html>